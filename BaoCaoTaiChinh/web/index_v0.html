<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Reports Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            text-align: center;
        }

        .stat-card h3 {
            color: #666;
            font-size: 1em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card .number {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }

        .filters {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .filters h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .view-mode-toggle {
            display: inline-flex;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .view-mode-toggle button {
            flex: 1;
            padding: 10px 20px;
            border: none;
            background: white;
            color: #666;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s, color 0.3s;
        }

        .view-mode-toggle button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .filter-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .filter-item {
            display: flex;
            flex-direction: column;
        }

        .filter-item label {
            color: #666;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .filter-item select,
        .filter-item input {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .filter-item select:focus,
        .filter-item input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .chart-card h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .data-table {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            overflow-x: auto;
        }

        .data-table h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f8f9fa;
            color: #333;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 0.5px;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.2em;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .status.online {
            background: #d4edda;
            color: #155724;
        }

        .status.offline {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Financial Reports Dashboard</h1>
            <p>Visualization & Analysis of Financial Data</p>
            <p style="margin-top: 10px;">
                <span class="status" id="apiStatus">Checking...</span>
            </p>
        </div>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <h3>Income Statement ¬∑ Ph·∫ßn I</h3>
                <div class="number" id="incomeP1Count">-</div>
                <p>Records</p>
            </div>
            <div class="stat-card">
                <h3>Income Statement ¬∑ Ph·∫ßn II</h3>
                <div class="number" id="incomeP2Count">-</div>
                <p>Records</p>
            </div>
            <div class="stat-card">
                <h3>Balance Sheets</h3>
                <div class="number" id="balanceCount">-</div>
                <p>Records</p>
            </div>
            <div class="stat-card">
                <h3>Cash Flow Statements</h3>
                <div class="number" id="cashFlowCount">-</div>
                <p>Records</p>
            </div>
        </div>

        <div class="filters">
            <h2>üîç Filters</h2>
            <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                <div>
                    <label style="display:block; color:#666; font-weight:600; margin-bottom:8px; font-size:0.9em;">View mode</label>
                    <div class="view-mode-toggle">
                        <button id="quarterModeBtn" class="active" onclick="setViewMode('quarter')">Quarter view</button>
                        <button id="yearModeBtn" onclick="setViewMode('year')">Year view</button>
                    </div>
                </div>
                <div style="color:#999; font-size:0.9em;">Year view = t·ª± ƒë·ªông d√πng Q5</div>
            </div>
            <div class="filter-group">
                <div class="filter-item">
                    <label>Report Type</label>
                    <select id="reportType">
                        <option value="income_statement_p1_raw">Income Statement ¬∑ Ph·∫ßn I</option>
                        <option value="income_statement_p2_raw" selected>Income Statement ¬∑ Ph·∫ßn II</option>
                        <option value="balance_sheet_raw">Balance Sheet</option>
                        <option value="cash_flow_statement_raw">Cash Flow</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>Stock</label>
                    <select id="stockFilter">
                        <option value="">All Stocks</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label>Year</label>
                    <select id="yearFilter">
                        <option value="">All Years</option>
                    </select>
                </div>
                <div class="filter-item" id="quarterFilterWrapper">
                    <label>Quarter</label>
                    <select id="quarterFilter">
                        <option value="">All Quarters</option>
                        <option value="1">Q1</option>
                        <option value="2">Q2</option>
                        <option value="3">Q3</option>
                        <option value="4">Q4</option>
                        <option value="5">Year-end</option>
                    </select>
                </div>
            </div>
            <button class="btn" onclick="loadData()">Load Data</button>
            <button class="btn" onclick="loadStats()" style="margin-left: 10px; background: #28a745;">Refresh Stats</button>
        </div>

        <div class="charts-grid">
            <div class="chart-card">
                <h3>Records by Year</h3>
                <canvas id="yearChart"></canvas>
            </div>
            <div class="chart-card">
                <h3>Records by Stock</h3>
                <canvas id="stockChart"></canvas>
            </div>
        </div>

        <div class="data-table">
            <h3>üìã Data Table</h3>
            <div id="tableContainer">
                <div class="loading">Select filters and click "Load Data" to view records</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://103.253.20.30:30011/api';
        const REPORT_CONFIG = {
            income_statement_p1_raw: {
                endpoint: 'income-statement',
                section: 'P1',
                label: 'Income Statement ¬∑ Ph·∫ßn I'
            },
            income_statement_p2_raw: {
                endpoint: 'income-statement',
                section: 'P2',
                label: 'Income Statement ¬∑ Ph·∫ßn II'
            },
            balance_sheet_raw: {
                endpoint: 'balance-sheet',
                label: 'Balance Sheet'
            },
            cash_flow_statement_raw: {
                endpoint: 'cash-flow',
                label: 'Cash Flow'
            }
        };
        let yearChart = null;
        let stockChart = null;
        let currentViewMode = 'quarter';

        // Check API status
        async function checkAPIStatus() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                const statusEl = document.getElementById('apiStatus');
                if (data.status === 'ok') {
                    statusEl.textContent = '‚úÖ API Online';
                    statusEl.className = 'status online';
                } else {
                    throw new Error('API not healthy');
                }
            } catch (error) {
                const statusEl = document.getElementById('apiStatus');
                statusEl.textContent = '‚ùå API Offline';
                statusEl.className = 'status offline';
            }
        }

        // Load statistics
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`);
                const result = await response.json();
                
                if (result.success) {
                    const stats = result.stats || {};
                    const safeNumber = (value) => typeof value === 'number' ? value : 0;
                    document.getElementById('incomeP1Count').textContent = safeNumber(stats.income_statement_p1_raw);
                    document.getElementById('incomeP2Count').textContent = safeNumber(stats.income_statement_p2_raw);
                    document.getElementById('balanceCount').textContent = safeNumber(stats.balance_sheet_raw);
                    document.getElementById('cashFlowCount').textContent = safeNumber(stats.cash_flow_statement_raw);
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load stocks
        async function loadStocks() {
            const reportType = document.getElementById('reportType').value;
            try {
                const response = await fetch(`${API_BASE}/stocks?table=${reportType}`);
                const result = await response.json();
                
                const select = document.getElementById('stockFilter');
                select.innerHTML = '<option value="">All Stocks</option>';
                
                if (result.success && result.stocks) {
                    result.stocks.forEach(stock => {
                        const option = document.createElement('option');
                        option.value = stock;
                        option.textContent = stock;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading stocks:', error);
            }
        }

        // Load years
        async function loadYears() {
            const reportType = document.getElementById('reportType').value;
            try {
                const response = await fetch(`${API_BASE}/years?table=${reportType}`);
                const result = await response.json();
                
                const select = document.getElementById('yearFilter');
                select.innerHTML = '<option value="">All Years</option>';
                
                if (result.success && result.years) {
                    result.years.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading years:', error);
            }
        }

        // Load data
        async function loadData() {
            const reportType = document.getElementById('reportType').value;
            const stock = document.getElementById('stockFilter').value;
            const year = document.getElementById('yearFilter').value;
            const quarterInput = document.getElementById('quarterFilter').value;
            const quarter = currentViewMode === 'year' ? '5' : quarterInput;
            const config = REPORT_CONFIG[reportType];

            if (!config) {
                document.getElementById('tableContainer').innerHTML = '<div class="error">Unsupported report type.</div>';
                return;
            }

            const params = new URLSearchParams();
            if (stock) params.append('stock', stock);
            if (year) params.append('year', year);
            if (quarter) params.append('quarter', quarter);
            if (config.section) params.append('section', config.section);

            try {
                document.getElementById('tableContainer').innerHTML = '<div class="loading">Loading...</div>';
                
                const queryString = params.toString();
                const requestUrl = queryString ? `${API_BASE}/${config.endpoint}?${queryString}` : `${API_BASE}/${config.endpoint}`;
                const response = await fetch(requestUrl);
                const result = await response.json();
                
                if (result.success) {
                    displayData(result.data, reportType);
                    updateCharts(result.data);
                } else {
                    document.getElementById('tableContainer').innerHTML = 
                        `<div class="error">Error: ${result.error}</div>`;
                }
            } catch (error) {
                document.getElementById('tableContainer').innerHTML = 
                    `<div class="error">Error loading data: ${error.message}</div>`;
            }
        }

        // Display data table
        function displayData(data, reportType) {
            if (!data || data.length === 0) {
                document.getElementById('tableContainer').innerHTML = 
                    '<div class="loading">No data found</div>';
                return;
            }

            const config = REPORT_CONFIG[reportType] || {};

            let html = `
                <p style="margin-bottom: 15px; color: #666;">
                    Showing ${data.length} record(s)
                </p>
                <table>
                    <thead>
                        <tr>
                            <th>Stock</th>
                            <th>Year</th>
                            <th>Quarter</th>
                            <th>Source File</th>
                            <th>Created At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            data.forEach(item => {
                const quarterValue = (item.quarter === null || item.quarter === undefined) ? 'null' : item.quarter;
                const sectionArg = config.section ? `'${config.section}'` : 'null';
                html += `
                    <tr>
                        <td><strong>${item.stock}</strong></td>
                        <td>${item.year}</td>
                        <td>${item.quarter || '-'}</td>
                        <td>${item.source_filename || '-'}</td>
                        <td>${item.created_at ? new Date(item.created_at).toLocaleString() : '-'}</td>
                        <td>
                            <button class="btn" onclick="viewDetails('${item.stock}', ${item.year}, ${quarterValue}, '${reportType}', ${sectionArg})" style="padding: 5px 15px; font-size: 0.9em;">
                                View
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            document.getElementById('tableContainer').innerHTML = html;
        }

        // Update charts
        function updateCharts(data) {
            // Year distribution
            const yearCounts = {};
            data.forEach(item => {
                yearCounts[item.year] = (yearCounts[item.year] || 0) + 1;
            });

            const yearCtx = document.getElementById('yearChart').getContext('2d');
            if (yearChart) yearChart.destroy();
            yearChart = new Chart(yearCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(yearCounts).sort(),
                    datasets: [{
                        label: 'Records',
                        data: Object.keys(yearCounts).sort().map(y => yearCounts[y]),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });

            // Stock distribution
            const stockCounts = {};
            data.forEach(item => {
                stockCounts[item.stock] = (stockCounts[item.stock] || 0) + 1;
            });

            const stockCtx = document.getElementById('stockChart').getContext('2d');
            if (stockChart) stockChart.destroy();
            
            const stockLabels = Object.keys(stockCounts).sort().slice(0, 10); // Top 10
            stockChart = new Chart(stockCtx, {
                type: 'doughnut',
                data: {
                    labels: stockLabels,
                    datasets: [{
                        label: 'Records',
                        data: stockLabels.map(s => stockCounts[s]),
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(118, 75, 162, 0.8)',
                            'rgba(239, 71, 111, 0.8)',
                            'rgba(255, 196, 61, 0.8)',
                            'rgba(6, 214, 160, 0.8)',
                            'rgba(17, 138, 178, 0.8)',
                            'rgba(247, 127, 0, 0.8)',
                            'rgba(155, 89, 182, 0.8)',
                            'rgba(52, 152, 219, 0.8)',
                            'rgba(46, 204, 113, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true
                }
            });
        }

        // View details (popup)
        function viewDetails(stock, year, quarter, reportType, section = null) {
            const detail = { stock, year, quarter, reportType };
            if (section) {
                detail.section = section;
            }
            const jsonStr = JSON.stringify(detail, null, 2);
            alert(`Details:\n${jsonStr}\n\n(Full JSON viewer coming soon!)`);
        }

        function setViewMode(mode) {
            currentViewMode = mode;
            const quarterWrapper = document.getElementById('quarterFilterWrapper');
            const quarterBtn = document.getElementById('quarterModeBtn');
            const yearBtn = document.getElementById('yearModeBtn');

            if (mode === 'year') {
                quarterWrapper.style.display = 'none';
                document.getElementById('quarterFilter').value = '';
                yearBtn.classList.add('active');
                quarterBtn.classList.remove('active');
            } else {
                quarterWrapper.style.display = '';
                quarterBtn.classList.add('active');
                yearBtn.classList.remove('active');
            }
        }

        // Event listeners
        document.getElementById('reportType').addEventListener('change', () => {
            loadStocks();
            loadYears();
        });

        // Initialize
        checkAPIStatus();
        loadStats();
        loadStocks();
        loadYears();
        setViewMode('quarter');

        // Auto-refresh stats every 30 seconds
        setInterval(() => {
            checkAPIStatus();
            loadStats();
        }, 30000);
    </script>
</body>
</html>

